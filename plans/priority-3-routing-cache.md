# P3 分流与缓存路径优化计划

## 目标
- 降低请求分流与模型解析对并发吞吐的影响。
- 降低缓存未命中导致的 DB 压力。
- 提升高并发下的平均与尾部延迟。

## 现状观察与定位
- 请求分流链路中包含模型解析、分组判定、缓存与 DB 访问，复杂度高：
  - [Distribute()](middleware/distributor.go:29)
  - [getModelRequest()](middleware/distributor.go:175)
- 路由解析依赖请求体读取与重复判断，多路径条件判断偏重。

## 优化策略（按实施优先级）

### 1. 分流路径缓存分层优化
- 方案
  - 将模型与分组解析结果做短期缓存，减少重复解析。
  - 针对热门模型启用缓存预热。
- 涉及位置
  - [getModelRequest()](middleware/distributor.go:175)
- 成功标准
  - 高频模型请求解析耗时下降。

### 2. 分流选择逻辑“快速路径”
- 方案
  - 对常见请求路径建立快速路径，减少复杂条件判断。
  - 对 body 读取减少重复解码。
- 涉及位置
  - [Distribute()](middleware/distributor.go:29)
  - [getModelRequest()](middleware/distributor.go:175)
- 成功标准
  - 分流 CPU 开销下降。

### 3. 缓存与 DB 访问顺序优化
- 方案
  - 优先命中内存缓存，失败再访问 Redis 与 DB。
  - 避免重复 DB 查询。
- 涉及位置
  - 缓存访问逻辑所在模块
- 成功标准
  - DB QPS 降低。
  - 缓存命中率提高。

### 4. 连接与超时策略调整
- 方案
  - 对分流路径中的外部依赖设置更合理超时。
  - 降低因阻塞导致的长尾延迟。
- 成功标准
  - 分流链路 P99 延迟下降。

## 实施步骤
1. 梳理分流路径的热点请求与常见模型。
2. 引入解析缓存与快速路径。
3. 调整缓存命中顺序与 DB 访问策略。
4. 压测验证吞吐与延迟改善。

## 风险与回滚
- 风险
  - 快速路径可能遗漏边界请求。
  - 缓存策略调整影响一致性。
- 回滚策略
  - 保留原有分流实现并提供开关。

## 依赖与验收
- 依赖
  - 分流路径性能指标采集。
  - 缓存命中率与 DB QPS 监控。
- 验收
  - 高并发下分流耗时明显下降。
  - 缓存命中率提升。

## 并发链路示意

```mermaid
flowchart LR
  A[请求进入] --> B[模型解析]
  B --> C[分流选择]
  C --> D[缓存与 DB]
  D --> E[上游转发]
```
